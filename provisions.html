<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body {
        font: 10px sans-serif;
    }

    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        size: 30px;
        shape-rendering: crispEdges;
    }

    .twitter-typeahead {
        width: 100%;
    }

    .tooltip text {
        font-family: sans-serif, helvetica;
    }
    .axis text {
        font-family: sans-serif, helvetica;
        font-size: 30px;
    }

    .x.axis path {
        display: none;
    }

    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 1.5px;
    }
</style>

<head>
    <!-- Bootstrap core CSS -->
    <link href="src/bootstrap.min.css" rel="stylesheet">
    <link rel="icon"
          type="image/png"
          href="favicon.ico">
          <script src='https://code.jquery.com/jquery-2.1.4.js'></script>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

</head>

<body>
  <script>
  $(function () {
      $('#example').popover({container:"body",viewport:'body'})
  });
  </script>


    <div class="container">

        <!-- Static navbar -->
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
<a class="navbar-brand" >Constitutionology</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="index">Home</a></li>
                        <li><a href="about">About</a></li>
                        <li><a href="network">Network</a></li>
                        <li><a href="timeline">Timeline</a></li>
                        <li class="active"><a href="provisions">Provisions</a></li>
                        <li><a href="tree">Tree</a></li>
                        <li><a href="data">Data</a></li>
                        <li><a href="faq">FAQ</a></li>

                    </ul>
                </div>
                <!--/.nav-collapse -->
            </div>
            <!--/.container-fluid -->
        </nav>


        <div id="the-basicsa" class="form-group col-md-12">
          <div id="the-basicsb" class="form-group col-md-1">
          <a tabindex="0" class="btn btn-lg btn-info" role="button" id="example"
          data-toggle="popover" data-placement="right" data-trigger="focus"
          data-html="true"
          data-max-width="1000px"
          data-content="
          This plot shows the historical trend in adoption of provisions over time.
          Each line shows the proportion of countries that exist in that year having a
          provision in their constitution addressing a particular issue. <br><br>There are 266 provisions
          related to questions such as <i>'Does the constitution provide for the right to protection
          from unjustified restraint (habeas corpus)?</i>'.<br><br>

          You can search for other provisions in the input box above.">
          ?</a>
        </div>
          <div id="the-basics" class="form-group col-md-11">
          <input class="typeahead form-control" type="text" placeholder="Provision">
        </div>



          <div id="the-d3" class="form-group col-md-12"></div>
    <!-- Bootstrap, working on Chrome?
<div class="dropdown" style="position: absolute; top:80px; left:90px;">
  <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1"
  data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" onchange=function({console.log('SELECTED')})>
    Provision
    <span class="caret"></span>
  </button>
  <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
    <li><a href="#">Action</a></li>
    <li><a href="#">Another action</a></li>
    <li><a href="#">Something else here</a></li>
    <li><a href="#">Separated link</a></li>
  </ul>
</div>
-->


    <script src="typeahead.bundle.js"></script>
    <script type="text/javascript">
    var substringMatcher = function(strs) {

      return function findMatches(q, cb) {

        var matches, substringRegex;

        // an array that will be populated with substring matches
        matches = [];

        // regex used to determine if a string contains the substring `q`
        substrRegex = new RegExp(q, 'i');

        // iterate through the pool of strings and for any string that
        // contains the substring `q`, add it to the `matches` array
        $.each(strs, function(i, str) {
          if (substrRegex.test(str)) {
            matches.push(str);
          }
        });

        cb(matches);
      };
    };



    var json = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': 'data/full_provision_descriptions_.json',
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })();

    keys=Object.keys(json)
    values=keys.map(function(d){return json[d];})

    console.log(values)

    $('#the-basics .typeahead').typeahead({
      hint: false,
      highlight: true,
      minLength: 1
    },
    {
      name: 'values',
      source: substringMatcher(values),
      limit:15
    });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <div class="col-sm-4">
    <script>

        var margin = {
            top: 20,
            right: 60,
            bottom: 200,
            left: 120
        };


        var w = window,
            d = document,
            e = d.documentElement,
            g = d.getElementsByTagName('body')[0],
            width = w.innerWidth || e.clientWidth || g.clientWidth,
            height = w.innerHeight || e.clientHeight || g.clientHeight;

        width = width - margin.left - margin.right,
            height = height - margin.top - margin.bottom;

        var tooltip = d3.select("#the-d3")
            .append("div")
            .style("position", "relative")
            .style('padding', ' 0px')
            .style("z-index", "0")
            //        	    .style('background-color','gray')
            .style("visibility", "hidden")
            .text("a simple tooltip").style('font-size', '30px');

        var parseDate = d3.time.format("%Y-%m-%d").parse; // %H:%M:%S").parse;

        var x = d3.time.scale()
            .range([0, width]);

        var y = d3.scale.linear()
            .range([height, 0]);

        var color = d3.scale.category10();

        var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var line = d3.svg.line()
            .interpolate("basis")
            .x(function(d) {
                return x(d.date);
            })
            .y(function(d) {
                return y(d.val);
            });


        var parseDate = d3.time.format("%Y-%m-%d").parse;
        bisectDate = d3.bisector(function(d) {
            return d.date;
        }).left;

        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


        d3.json('data/full_provision_descriptions_.json', function(data2) {

          //  $.each(data2, function(key, value) {
          //      $('#dropdown').append('<option value=' + key + '>' + value + '</option>');
          //  });

            d3.tsv("data/total_.csv", function(error, data) {
                if (error) throw error;

                var temp=data.map(function(v, i) {
                    return +v.doubjep;})

                console.log('GOT 4: '+temp)

                var dates = data.map(function(v, i) {
                    return parseDate(v.date);
                });

                var lineChosen = d3.svg.line()
                    .interpolate("basis")
                    .y(function(d) {
                        return y(d);
                    })
                    .x(function(d, i) {
                        return x(dates[i]);
                    })


                var selectProvision = function(prov) {
                    console.log('GOT: '+prov)
                    console.log('GOT 2: '+values.indexOf(prov))

                    chosen.attr("d", function(d) {
                        k=keys[values.indexOf(prov)];
                        console.log('GOT 3: '+k)
                        k=k.toLowerCase();

                        return lineChosen(data.map(

                            function(v, i) {
                                if(k=='habcorp'){console.log('habeas '+v[k])}
                                return +v[k];
                            }))
                    });

                };


                //$('#dropdown').change(selectProvision)

                var mouseOverFunction = function(d) {
                    tooltip.style("visibility", "visible");
                    x0 = x.invert(d3.mouse(this)[0]);
                    var i = bisectDate(data, x0, 1);
                    var yearFormat = d3.time.format("%Y");
                    tooltip.text('The value of ' + d.name + ' ' + yearFormat(x0)), d3.select(this).transition()
                        .style('stroke', 'black').style('stroke-width', '5px');
                };

                var mouseOutFunction = function(d) {
                    tooltip.style("visibility", "hidden"), d3.select(this).transition().style('stroke', 'lightgrey').style('stroke-width', '1.5px')
                };


                color.domain(d3.keys(data[0]).filter(function(key) {
                    return key !== "date";
                }));

                data.forEach(function(d) {
                    d.date = parseDate(d.date);
                });

                var cities = color.domain().map(function(name) {
                    return {
                        name: name,
                        values: data.map(function(d) {
                            return {
                                date: d.date,
                                val: d[name]
                            };
                        })
                    };
                });

                x.domain([d3.min(data, function(d) {
                    return d.date;
                }), parseDate("2013-01-31")]);
                x.domain(d3.extent(data, function(d) {
                    return d.date;
                }));

                //x.domain()[1]=parseDate("2013-01-31")

                y.domain([
                    d3.min(cities, function(c) {
                        return d3.min(c.values, function(v) {
                            return v.val;
                        });
                    }),
                    d3.max(cities, function(c) {
                        return d3.max(c.values, function(v) {
                            return v.val;
                        });
                    })
                ]);

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 12)
                    .attr("dy", "1.5em")
                    .style("text-anchor", "end")
                    //      .text("Val");

                var city = svg.selectAll(".city")
                    .data(cities)
                    .enter().append("g")
                    .attr("class", "city");

                var chosen = svg.append("g").append("path").attr("id", "chosen").style('stroke', 'black').style('stroke-width', '4px')
                    .attr("class", "line");

                city.append("path")
                    .attr("class", "line")
                    .attr("d", function(d) {
                        return line(d.values);
                    })
                    .style("stroke", "#ddddd9").style("stroke-opacity", '0.75')
                    .on("onclick", mouseOverFunction)
                    .on("mouseout", mouseOutFunction);

                names = cities.map(function(d) {
                    return d.name;
                });




                //  city.append("text")
                //      .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
                //      .attr("transform", function(d) { return "translate(" + x(d.value.date) + "," + y(d.value.val) + ")"; })
                //      .attr("x", 3)
                //      .attr("dy", ".35em")
                //      .text(function(d) { return d.name; });

                $('.typeahead').bind('typeahead:select', function(ev, suggestion) {
                    console.log('NOW GOT'+suggestion)
                    selectProvision(suggestion);
                });


            });
        });


    </script>
  </div>
  </div>
</div>
