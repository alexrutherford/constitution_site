<!DOCTYPE html>
<meta charset="utf-8">
<style>

img {
    width: 100%;
}

.node {
  cursor: pointer;
}

.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 0.5px;
}

.node text {
  font: 12px helvetica;
  fill:black
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}

.twitter-typeahead {
 width:100%;
 }

</style>
  <head>
    <!-- Bootstrap core CSS -->
    <link href="src/bootstrap.min.css" rel="stylesheet">
    <link rel="icon"
          type="image/png"
          href="favicon.ico">
          <script src='https://code.jquery.com/jquery-2.1.4.js'></script>

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <title>Constitutionology - Hierarchy</title>

  </head>
  <body>
    <script>
    $(function () {
        $('#example').popover({container:"body",viewport:'body'})
    });
    </script>

    <script>
    var margin = {
        top: 20,
        right: 20,
        bottom: 300,
        left: 120
    };


    var w = window,
        d = document,
        e = d.documentElement,
        g = d.getElementsByTagName('body')[0],
        width = w.innerWidth || e.clientWidth || g.clientWidth,
        height = w.innerHeight || e.clientHeight || g.clientHeight;

    width = width - margin.left - margin.right,
        height = height - margin.top - margin.bottom;

    </script>


    <div class="container">

      <!-- Static navbar -->
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" style="font-size:2.3em !important" href="/">Constitutionology</a>
          </div>
          <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li><a href="network"><img class="media-object" src="png_24/007-network-border.png"
                onmouseover="this.src='png_32/007-network.png';"
                onmouseout="this.src='png_24/007-network-border.png';"></a></li>
              <li><a href="map"><img class="media-object" src="png_24/008-global-border.png"
                onmouseover="this.src='png_32/008-global.png';"
                onmouseout="this.src='png_24/008-global-border.png';"></span></a></li>
              <li ><a href="timeline"><img class="media-object" src="png_24/005-graphic-1-border.png"
                onmouseover="this.src='png_32/005-graphic-1.png';"
                onmouseout="this.src='png_24/005-graphic-1-border.png';"></span></a></li>
              <li><a href="provisions"><img class="media-object" src="png_24/006-graphic-border.png"
                onmouseover="this.src='png_32/006-graphic.png';"
                onmouseout="this.src='png_24/006-graphic-border.png';"
                ></a></li>
              <li><a href="tree"><img class="media-object" src="png_24/004-nature-border.png"
                onmouseover="this.src='png_32/004-nature.png';"
                onmouseout="this.src='png_24/004-nature-border.png';"></span></a></li>
              <li><a href="hierarchy"><img class="media-object" src="png_24/003-business-border.png"
                onmouseover="this.src='png_32/003-business.png';"
                onmouseout="this.src='png_24/003-business-border.png';"
                ></a></li>
              <li><a href="faq"><img class="media-object" src="png_24/002-mark-border.png"
                onmouseover="this.src='png_32/002-mark.png';"
                onmouseout="this.src='png_24/002-mark-border.png';"
                ></a></li>
              <li><a href="about"><img class="media-object" src="png_24/001-about-us-border.png"
                onmouseover="this.src='png_32/001-about-us.png';"
                onmouseout="this.src='png_24/001-about-us-border.png';"
                 ></a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div><!--/.container-fluid -->
      </nav>

      <div class="well">
        <div class="media">
      <h4>Some constitutional provisions tend to be included in a country's
        constitution before others. For example, describing how a constitution
        can be amended is a fundamental aspect of a constitution whereas provisions
      protecting marginalised groups may take longer to appear within a constitution.
      The order in which provisions are adopted naturally describes a hierarchy shown below.
      </a>
      </h4>
      </div>
      </div>


  <div class="tabbable"> <!-- Only required for left/right tabs -->
    <ul class="nav nav-tabs">
      <li class="active"><a href="#tab1" data-toggle="tab">Full hierarchy</a></li>
      <li ><a href="#tab2" data-toggle="tab">Upper hierarchy</a></li>
      <li ><a href="#tab3" data-toggle="tab">Lower hierarchy</a></li>
      <li><a href="#tab4" data-toggle="tab">Work hierarchy</a></li>
      <li><a href="#tab5" data-toggle="tab">Education hierarchy</a></li>
    </ul>
    <div class="tab-content" width=width>

      <div class="tab-pane active" id="tab1" width=width>
        <!-- <div class="well">
          <div class="media">
        <h4>Search for provisions e.g. "The right to safe working conditions" or "Equality of gender" to see
          their position in the provision hierarchy. Provisions to the left are generally adopted before
          provisions on the right. The left and right keys move the focus.</a>
        </h4>
        </div>
        </div> -->

        <div id="the-basics" width=100%>
          <input id="myTypeAhead" class="typeahead form-control" style="position: relative; display: inline-block; width:100%;" type="text" placeholder="Search for provisions related to something e.g. children, work, education">
        </div>
        <br>

<div style="text-align:right">
  <button class="btn btn-primary" id="randomButton" style="padding: 5px 10px;">I'm feeling lucky</button>
</div>

<script src="src/typeahead.bundle.js"></script>
<script type="text/javascript">

var substringMatcher = function(strs) {

  return function findMatches(q, cb) {

    var matches, substringRegex;

    // an array that will be populated with substring matches
    matches = [];

    // regex used to determine if a string contains the substring `q`
    substrRegex = new RegExp(q, 'i');

    // iterate through the pool of strings and for any string that
    // contains the substring `q`, add it to the `matches` array
    $.each(strs, function(i, str) {
      if (substrRegex.test(str)) {
        matches.push(str);
      }
    });

    cb(matches);
  };
};

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<div class="col-sm-4">

<script src="https://d3js.org/d3.v3.min.js"></script>

<script>



var xFunc = function(i) { return i * ((width+0.01)/data.length)};


d3.csv('data/out_ranks_provisions_no_ties.txt', function(pos2name) {

  revKeys=pos2name.map(function(d){return +d['n'];});

d3.tsv('data/provision_adjacency_index.txt', function(data2) {


d3.csv("data/names_sorted.txt", function(trans) {
  data=trans.map(function(d)
{
return d['name'];
});

var json = (function () {
    var json = null;
    $.ajax({
        'async': false,
        'global': false,
        'url': 'data/full_provision_descriptions_.json',
        'dataType': "json",
        'success': function (data) {
            json = data;
        }
    });
    return json;
})();

document.onkeydown = checkKey;

function checkKey(e) {

    e = e || window.event;

    if (e.keyCode == '37') {
       // left arrow

       if(highlighted>0)
       // Don't overflow
       {
       mouseout(circleEnter[0][highlighted],highlighted);
       highlighted=highlighted-1;
       mouseover(circleEnter[0][highlighted],highlighted)

       $("#myTypeAhead").typeahead('val',json[data[highlighted].toUpperCase()]);
        }
    }
    else if (e.keyCode == '39') {
       // right arrow
       if(highlighted<keys.length-1)
       // Don't overflow
       {


        mouseout(circleEnter[0][highlighted],highlighted);
        highlighted=highlighted+1;
        mouseover(circleEnter[0][highlighted],highlighted)

        $("#myTypeAhead").typeahead('val',json[data[highlighted].toUpperCase()]);
      }
    }

}


highlighted=-1;

keys=Object.keys(json)

keys=keys.map(function(d){return d.toLowerCase();})
values=keys.map(function(d){return json[d.toUpperCase()];})

$('#the-basics .typeahead').typeahead({
  hint: false,
  highlight: true,
  minLength: 1
},
{
  name: 'values',
  source: substringMatcher(values),
  limit:15
});

$('.typeahead').bind('typeahead:select', function(ev, suggestion) {

    selectProvision(suggestion);
});

var selectProvision = function(prov) {


    i=values.indexOf(prov);

    if(highlighted){console.log("Selected:mouseout "+highlighted);mouseout(circleEnter[0][highlighted],highlighted);}
    highlighted=data.indexOf(keys[i]);
    mouseover(circleEnter[0][highlighted],highlighted)
  };

  var selectRandom=function()
  {
    temp=Math.floor(Math.random() * keys.length);
    var chosen=values[temp];


    $("#myTypeAhead").typeahead('val',chosen);
    selectProvision(chosen);

  }

  $(document).ready(function(){
    $('#randomButton').click(function(){
       selectRandom();
    });
  });


var colorScale = d3.scale.linear().domain([0, keys.length]).range(['#ff1a1a','#4d4dff']);

var mid=200;

var highlighted=false;

// Set the dimensions of the canvas / graph
var margin = {top: 20, right: 10, bottom: 290, left: 30}

var drawArcs = function(i)
{
  var delta=20;

  for(j=0;j<values.length;j++)
  {
    var lineGenerator = d3.svg.line().interpolate("monotone");

    var heightFunc = function(i,j){

      var temp = 1.0*mid*(i-j)/values.length;

      return temp;
    }

    var yOffset=0;
    var xOffset=1;

    if (j<i){
      yOffset=5;
      xOffset=1}
    else{yOffset=-5;
    xOffset=-1}

     var lineData=[[xFunc(i),mid+yOffset],[xFunc(i)+((xFunc(j)-xFunc(i))/2),
       mid+heightFunc(i,j)+yOffset],[xFunc(j),mid+yOffset]];

     var x = svg.append("path")
    .attr("d", lineGenerator(lineData))
    .attr("stroke", colorScale(j))
    .attr("stroke-width", parseFloat(data2[i][j])/30.)
    .attr("fill", "none")
    .attr("id", "id"+j);
//        .duration(durationTime)
//        .attr("stroke-width", 0.2);


  }

}

var durationTime = 1000;


        function mouseout(d,i) {


            $("#myTypeAhead").typeahead('val','');

            d3.select(circleEnter[0][i]).transition()
            .duration(durationTime)
            .attr("r", 2)
            .attr('fill-opacity', 1.0);


            d3.select("#id"+data[i]["name"]).remove();



            for(j=0;j<values.length;j++)
            {
              d3.select("#id"+j).remove();
            }
        }


        // Adds the svg canvas
        var svg = d3.select("body")
            .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform",
                      "translate(" + margin.left + "," + margin.top + ")");

        var circle = svg.selectAll("circle")
            .data(data.map(function(d){return d["name"]}));

            function mouseover(d,i) {



                if (highlighted){mouseout(circleEnter[0][highlighted],highlighted);}

                if($("#myTypeAhead").val().length==0){
                  $("#myTypeAhead").typeahead('val',json[data[i].toUpperCase()]);
              }
              else{
                //mouseout(circleEnter[0][highlighted],highlighted);
              }

                highlighted=i;

                d3.select(circleEnter[0][i]).transition()
                .duration(durationTime)
                .attr("r", 10)
                .attr('fill-opacity', 0.5);


                drawArcs(i);

                desc=(i+1)+" of 234";
                //desc=desc + json[data[i].toUpperCase()];

                svg.append("text").attr({
                  //x: i * ((width+0.01)/data.length),
                  //y: 40,
                  x:margin.left,
                  y:0,
                  id: "id"+data[i]["name"],
                  fill:"grey",

                })
                .style({'font-size':"20px","padding": "5px 10px",'align':'right'})
                .text(desc);

            }


        var circleEnter = circle.enter().append("circle")
        .on("mouseover", mouseover);
        //.on("mouseout", mouseout);


        circleEnter.text(function(d,i){return data[i]["name"]});

        circleEnter.attr("cy", mid);
        circleEnter.attr("cx", function(d,i) {return xFunc(i)});
        circleEnter.attr("r", function(d) { return 2});
        circleEnter.attr("name",function(d,i){return data[i]["name"];});
        circleEnter.attr("fill", function(d,i){return colorScale(i)});
  });
});
});
</script>


      </div>
      </div>

      <div class="tab-pane" id="tab2">
          <img class="media-object" src="img/hierarchy_high_focused.png">
      </div>

      <div class="tab-pane" id="tab3">
          <img class="media-object" src="img/hierarchy_low_focused.png">
      </div>

      <div class="tab-pane" id="tab4">
          <img class="media-object" src="img/hierarchy_selected_work.png">
      </div>

      <div class="tab-pane" id="tab5">
          <img class="media-object" src="img/hierarchy_selected_education.png">
      </div>


    </div>
  </div>
</div>

</div>
